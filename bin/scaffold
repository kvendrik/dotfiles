#!/bin/bash

SCAFFOLD_TEMPLATES_PATH="$HOME/.scaffold-templates"
TEMPLATE_NAME="$1"
PROJECT_NAME="$2"
PROJECT_PATH="$HOME/Desktop/$PROJECT_NAME"
TODAY_DATE="$(date -I)"
LAST_UPDATED_FILE_PATH="$SCAFFOLD_TEMPLATES_PATH/.scaffold_last_fetch_date"

function edit_template() {
  vim "$TEMPLATE_NAME.sh" && git add -A && git commit -m "update" && git push
}

if [ ! -d "$SCAFFOLD_TEMPLATES_PATH" ]; then
  if ! git clone git@gist.github.com:5feb8a8f1463bcb1c4811b04246fd018.git "$SCAFFOLD_TEMPLATES_PATH"; then
    exit 1
  fi
fi

if [ ! -f "$LAST_UPDATED_FILE_PATH" ]; then
  echo "$TODAY_DATE" > "$LAST_UPDATED_FILE_PATH"
fi

cd "$SCAFFOLD_TEMPLATES_PATH"

if [ "$(cat "$LAST_UPDATED_FILE_PATH")" != "$TODAY_DATE" ]; then
  echo "Updating..."
  git pull && echo "$TODAY_DATE" > "$LAST_UPDATED_FILE_PATH"
fi

if [ -z "$TEMPLATE_NAME" ]; then
  echo "
Usage: scaffold <template> [<project_name>]. 

Templates:
$(ls | grep -Eo "^[^\.]+")
"
  exit 0
fi

if [ -f "$TEMPLATE_NAME.sh" ]; then
  if [ -z "$PROJECT_NAME" ]; then
    edit_template
    exit 0
  fi

  if [ -d "$PROJECT_PATH" ]; then
    echo "$PROJECT_PATH exists"
    exit 1
  fi

  printf "✨ Running ‘sh "$TEMPLATE_NAME.sh" "$PROJECT_PATH"’\n\n"
  sh "$TEMPLATE_NAME.sh" "$PROJECT_PATH"

  exit 0
fi

edit_template
